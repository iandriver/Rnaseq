#-*-python-*-

# The main rnaseq entry point
# fixme: right now it's just a testbed for development

import sys, os, yaml, optparse, sqlite3
from warn import *

# Try to load the rnaseq modules:
try:
    from Rnaseq import *
except Exception as e:
    needed_dir=os.path.normpath(os.path.abspath(__file__)+"/../../lib")
    sys.stderr.write("Unable to import Rnaseq.  Perhaps you need to add "+needed_dir+" to your PYTHONPATH?\n")
    sys.stderr.write(yaml.dump(e))
    sys.stderr.write("(%s)\n" % e)
    sys.exit(1)


# global variables:
options={}                              # reset by parse_cmdline()

def main():
    usage="usage: %s <cmd> [-p <pipeline>] [-r <readset>] [options]" % sys.argv[0] # fixme: form might be different; might be more like git
    argv=parse_cmdline(usage)       # not to be confused with sys.argv
    try: 
        cmd=argv[1]
    except IndexError as ie:
        die(UserError(usage))

    
    config=read_config()
    options.config=config
    #print "config is %s" % config

    dbh=sqlite3.connect("db/%s" % config['db']['db_name'])

    cf=CmdFactory(program='rnaseq')
    cf.add_cmds(options.config['cmds'])
    cmd=cf.new_cmd(cmd)
    cmd.run(dbh=dbh, argv=argv, options=options)

    
    print "rnaseq: done"


########################################################################

# what to return? probably parsed argv
def parse_cmdline(usage):                    
    parser=optparse.OptionParser(usage)

    parser.add_option("-r","--readset", dest="readset_name", help="readset name")
    parser.add_option("-p","--pipeline", dest="pipeline_name", help="pipeline name")
    parser.add_option("-f","--config", dest="config", help="specify alternative config file",
                      default=os.path.normpath(os.path.abspath(__file__)+"/../../config/rnaseq.conf.yml"))
    parser.add_option('--cluster', dest='use_cluster', action='store_true', default=False)

    (values, argv)=parser.parse_args(sys.argv)
    global options
    options=values
    return argv                         # return remaining argv values


########################################################################

def read_config():
    try: 
        config_file=options.config
        f=open(config_file)
        yml=f.read()
        f.close()
        config=yaml.load(yml)
        return config
    except IOError as ioe:
        warn("error trying to load global config file:")
        die(UserError(ioe))


########################################################################

main()
